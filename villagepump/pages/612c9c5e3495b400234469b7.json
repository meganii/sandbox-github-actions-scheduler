{
  "id": "612c9c5e3495b400234469b7",
  "title": "localhostとCORS",
  "created": 1630313568,
  "updated": 1630553656,
  "lines": [
    {
      "id": "612c9c5e3495b400234469b7",
      "text": "localhostとCORS",
      "userId": "5a4873ab2e26fb001479d3a9",
      "created": 1630313568,
      "updated": 1630313568
    },
    {
      "id": "612c9c5f79d3a9000086380c",
      "text": "[/sta/ScrapboxのCORS]",
      "userId": "5a4873ab2e26fb001479d3a9",
      "created": 1630313568,
      "updated": 1630313568
    },
    {
      "id": "612c9c5f79d3a9000086380d",
      "text": " 確かにlocalで立ち上げたserverからならCORSを無視してfetchできますが、http://localhost に接続して開いた[* web page]からは不可能です[takker.icon]",
      "userId": "5a4873ab2e26fb001479d3a9",
      "created": 1630313568,
      "updated": 1630313568
    },
    {
      "id": "612c9c5f79d3a9000086380e",
      "text": "  serverではなくclient経由でfetchしている",
      "userId": "5a4873ab2e26fb001479d3a9",
      "created": 1630313568,
      "updated": 1630313568
    },
    {
      "id": "612c9c5f79d3a9000086380f",
      "text": "  localで立ち上げたserverにアクセスする＝http://localhost に接続する、だと思ってます[sta.icon]",
      "userId": "5a4873ab2e26fb001479d3a9",
      "created": 1630313568,
      "updated": 1630313568
    },
    {
      "id": "612c9c5f79d3a90000863810",
      "text": "  \thttp://localhost にアクセスする以外の「localで立ち上げたserverにアクセスする」方法がある？",
      "userId": "5a4873ab2e26fb001479d3a9",
      "created": 1630313568,
      "updated": 1630313568
    },
    {
      "id": "612c9c5f79d3a90000863811",
      "text": "  \t[- たぶん下図で解説されてそうですが、まだピンと来てないのであとでじっくり]",
      "userId": "5a4873ab2e26fb001479d3a9",
      "created": 1630313568,
      "updated": 1630313568
    },
    {
      "id": "612c9c5f79d3a90000863812",
      "text": "  \t\t理解した！",
      "userId": "5a4873ab2e26fb001479d3a9",
      "created": 1630313568,
      "updated": 1630313568
    },
    {
      "id": "612c9c5f79d3a90000863813",
      "text": "  \t\tScrapbox.ioとの通信を「serverから行うか」「（serverから転送したassetsを使ってる）browserから行うか」の違いか",
      "userId": "5a4873ab2e26fb001479d3a9",
      "created": 1630313568,
      "updated": 1630313568
    },
    {
      "id": "612c9c5f79d3a90000863814",
      "text": "  \t\t前者はいける（ローカルPCからcurl叩いたりするのと一緒）",
      "userId": "5a4873ab2e26fb001479d3a9",
      "created": 1630313568,
      "updated": 1630313568
    },
    {
      "id": "612c9c5f79d3a90000863815",
      "text": "  \t\t後者はいけない（Scrapbox.ioが from localhost をガードしている）",
      "userId": "5a4873ab2e26fb001479d3a9",
      "created": 1630313568,
      "updated": 1630313568
    },
    {
      "id": "612c9c5f79d3a90000863816",
      "text": " [https://kakeru.app/a007df0dbbf2a7c1ae4d4e364b4efd28 https://i.kakeru.app/a007df0dbbf2a7c1ae4d4e364b4efd28.svg]",
      "userId": "5a4873ab2e26fb001479d3a9",
      "created": 1630313568,
      "updated": 1630313568
    },
    {
      "id": "612c9c5f79d3a90000863817",
      "text": "",
      "userId": "5a4873ab2e26fb001479d3a9",
      "created": 1630313568,
      "updated": 1630313568
    },
    {
      "id": "612e455faff09e00008b3189",
      "text": "[nishio.icon]既にかなり説明されてた",
      "userId": "582e63d27c56960011aff09e",
      "created": 1630422369,
      "updated": 1630422379
    },
    {
      "id": "612e4561aff09e00008b318a",
      "text": "　こういうことをしたのです",
      "userId": "582e63d27c56960011aff09e",
      "created": 1630422369,
      "updated": 1630422877
    },
    {
      "id": "612e475daff09e00008b318c",
      "text": "　[https://gyazo.com/2dba023d5006b6d506f526d52bd3b7d2]",
      "userId": "582e63d27c56960011aff09e",
      "created": 1630422878,
      "updated": 1630422879
    },
    {
      "id": "612e475eaff09e00008b318d",
      "text": "　>これはlocalhost:5001で動かしているローカルサーバーに対して regroup-d4932/us-central1/get_scrapbox_page をリクエストしているだけ",
      "userId": "582e63d27c56960011aff09e",
      "created": 1630422879,
      "updated": 1630423693
    },
    {
      "id": "612e4a8baff09e00007b9479",
      "text": "\t　Cloud Functionは前半ではlocalhost:5001の開発サーバで動いていて、後半ではcloudfunctions.netにデプロイされてます",
      "userId": "582e63d27c56960011aff09e",
      "created": 1630423691,
      "updated": 1630423737
    },
    {
      "id": "612e48bbaff09e00008b3192",
      "text": "　　[/nishio/Cloud FunctionsでScrapboxのAPIを叩く#612badddaff09e0000df1fbd]",
      "userId": "582e63d27c56960011aff09e",
      "created": 1630423228,
      "updated": 1630423229
    },
    {
      "id": "612e48f3aff09e00008b3193",
      "text": "　なので、下記をScrapbox以外のオリジンを開いてるブラウザ上で実行してもScrapbox APIの結果が得られるわけです(明示的に書いてなかったので今加筆した)",
      "userId": "582e63d27c56960011aff09e",
      "created": 1630423283,
      "updated": 1630423660
    },
    {
      "id": "612e4966aff09e00008b3194",
      "text": "　code:ts",
      "userId": "582e63d27c56960011aff09e",
      "created": 1630423398,
      "updated": 1630423399
    },
    {
      "id": "612e4967aff09e00008b3195",
      "text": "  fetch(\"https://us-central1-regroup-d4932.cloudfunctions.net/get_scrapbox_page\", {",
      "userId": "582e63d27c56960011aff09e",
      "created": 1630423399,
      "updated": 1630423399
    },
    {
      "id": "612e4967aff09e00008b3196",
      "text": "    method: \"post\",",
      "userId": "582e63d27c56960011aff09e",
      "created": 1630423399,
      "updated": 1630423399
    },
    {
      "id": "612e4967aff09e00008b3197",
      "text": "    body: JSON.stringify({",
      "userId": "582e63d27c56960011aff09e",
      "created": 1630423399,
      "updated": 1630423399
    },
    {
      "id": "612e4967aff09e00008b3198",
      "text": "      url: \"https://scrapbox.io/nishio/2021-08-28Kozaneba%E9%96%8B%E7%99%BA%E6%97%A5%E8%A8%98\",",
      "userId": "582e63d27c56960011aff09e",
      "created": 1630423399,
      "updated": 1630423399
    },
    {
      "id": "612e4967aff09e00008b3199",
      "text": "    }),",
      "userId": "582e63d27c56960011aff09e",
      "created": 1630423399,
      "updated": 1630423399
    },
    {
      "id": "612e4967aff09e00008b319a",
      "text": "  })",
      "userId": "582e63d27c56960011aff09e",
      "created": 1630423399,
      "updated": 1630423399
    },
    {
      "id": "612e4967aff09e00008b319b",
      "text": "    .then((x) => x.json())",
      "userId": "582e63d27c56960011aff09e",
      "created": 1630423399,
      "updated": 1630423399
    },
    {
      "id": "612e4967aff09e00008b319c",
      "text": "    .then((x) => console.log(x));",
      "userId": "582e63d27c56960011aff09e",
      "created": 1630423399,
      "updated": 1630423399
    },
    {
      "id": "612e4967aff09e00008b319d",
      "text": "　ガンガン使われて課金が来ると困るけどちょだと試してみる分には上記のCloud Functionを使ってみてもいいですよ",
      "userId": "582e63d27c56960011aff09e",
      "created": 1630423399,
      "updated": 1630423608
    },
    {
      "id": "6130042c79d3a90000158495",
      "text": "　\tありがとうございます。CORS周り全然わからないのですごく勉強になりました。お試しは……迷惑かけるの怖いので自分の方で試してみることにします（Firebase未経験ですし）[sta.icon]",
      "userId": "5a4873ab2e26fb001479d3a9",
      "created": 1630536749,
      "updated": 1630536923
    },
    {
      "id": "6130042d79d3a90000158496",
      "text": " ちなみにこのコードはweb page自体が`us-central1-regroup-d4932.cloudfunctions.net`への通信を許可していない限り実行する事ができません[takker.icon]",
      "userId": "5ef2bdebb60650001e1280f0",
      "created": 1630536751,
      "updated": 1630553526
    },
    {
      "id": "613045401280f00000647f24",
      "text": "  server→clientで許可が降りていても([CORS]が許可されていても)、client→serverの段階で止められてしまったら([CSP]が許可されていなかったら)通信しようがない",
      "userId": "5ef2bdebb60650001e1280f0",
      "created": 1630553409,
      "updated": 1630553521
    },
    {
      "id": "6130452e1280f00000647f23",
      "text": " 　実際、scrapbox.io上でこのコードを実行するとエラーがでます",
      "userId": "5ef2bdebb60650001e1280f0",
      "created": 1630553390,
      "updated": 1630553656
    },
    {
      "id": "613044f41280f00000647f22",
      "text": "  ……の、はずなのですが何故かFirefoxでは通ってしまう！",
      "userId": "5ef2bdebb60650001e1280f0",
      "created": 1630553332,
      "updated": 1630553562
    },
    {
      "id": "613045dc1280f00000647f26",
      "text": "   [FirefoxのCSPガバガバ説]の証拠が増えたぞ！()[takker.icon]",
      "userId": "5ef2bdebb60650001e1280f0",
      "created": 1630553564,
      "updated": 1630553609
    },
    {
      "id": "613045fe1280f00000647f27",
      "text": "   これ明らかにバグですよね……Mozillaに報告したほうが良いのかな……？",
      "userId": "5ef2bdebb60650001e1280f0",
      "created": 1630553598,
      "updated": 1630553637
    },
    {
      "id": "613045bf1280f00000647f25",
      "text": "",
      "userId": "5ef2bdebb60650001e1280f0",
      "created": 1630553535,
      "updated": 1630553535
    }
  ]
}