{
  "id": "64044fd69bc807001c7d1d94",
  "title": "渡せるtokenいっぱいまで渡したい",
  "created": 1678004183,
  "updated": 1679420715,
  "lines": [
    {
      "id": "64044fd69bc807001c7d1d94",
      "text": "渡せるtokenいっぱいまで渡したい",
      "userId": "582e63d27c56960011aff09e",
      "created": 1678004183,
      "updated": 1678004183
    },
    {
      "id": "64044fd7aff09e00001130a0",
      "text": "from [2023/2/21 Scrapboxの内容を元にしたチャットbotを実装する]",
      "userId": "582e63d27c56960011aff09e",
      "created": 1678004183,
      "updated": 1678004183
    },
    {
      "id": "64044fd7aff09e00001130a1",
      "text": "現状毎回4チャンクだけ文章を取ってきているが、渡せるtokenいっぱいまで渡したい[blu3mo.icon]",
      "userId": "582e63d27c56960011aff09e",
      "created": 1678004183,
      "updated": 1678004202
    },
    {
      "id": "64072f625e90c00000065152",
      "text": "  歌詞みたい[issac-37765679.icon]",
      "userId": "60508ed36a7abc00235e90c0",
      "created": 1678192476,
      "updated": 1678203249
    },
    {
      "id": "6407d2345e90c00000bfaf05",
      "text": " 　→[渡せるtokenいっぱいまで渡したいの歌]",
      "userId": "60508ed36a7abc00235e90c0",
      "created": 1678234163,
      "updated": 1678234288
    },
    {
      "id": "64044fd7aff09e00001130a3",
      "text": "　わかるわかる[nishio.icon]",
      "userId": "582e63d27c56960011aff09e",
      "created": 1678004183,
      "updated": 1678004193
    },
    {
      "id": "64044fd7aff09e00001130a4",
      "text": "　ベストマッチから4チャンク連続で取ってる？",
      "userId": "582e63d27c56960011aff09e",
      "created": 1678004183,
      "updated": 1678004193
    },
    {
      "id": "64044fd7aff09e00001130a5",
      "text": "　 yes[blu3mo.icon]",
      "userId": "582e63d27c56960011aff09e",
      "created": 1678004183,
      "updated": 1678004193
    },
    {
      "id": "64044fd7aff09e00001130a6",
      "text": "　個人的にはTop Kの値を増やして「関係ありそうなところをあちこち読む」のの方が「[関係の発見]」を強く支援してくれるのではないかと思ってる([類似度Top Kをプロンプトに積みたい])",
      "userId": "582e63d27c56960011aff09e",
      "created": 1678004183,
      "updated": 1678004193
    },
    {
      "id": "64044fd7aff09e00001130a7",
      "text": "　 それに合った適切なPromptを見つけられれば、良さそう[blu3mo.icon]",
      "userId": "582e63d27c56960011aff09e",
      "created": 1678004183,
      "updated": 1678004193
    },
    {
      "id": "64044fd7aff09e00001130a8",
      "text": "　　 現状、渡したドキュメントをそのまま吐き出すみたいな回答をしてくるので、そのPromptのままでソースのランダムさを高めると回答がよりとんちんかんになりそう",
      "userId": "582e63d27c56960011aff09e",
      "created": 1678004183,
      "updated": 1678004193
    },
    {
      "id": "64044fd7aff09e00001130a9",
      "text": "　　なるほど[nishio.icon]",
      "userId": "582e63d27c56960011aff09e",
      "created": 1678004183,
      "updated": 1678004193
    },
    {
      "id": "64044fd7aff09e00001130aa",
      "text": "　　\t今のクオリアさんは「下記の議論を参考にあなたの意見を述べよ」ってプロンプトなので僕の意見や他人のTweetやScrapbox上の議論を雑に突っ込んで運用してるけどあんまり気にならないな",
      "userId": "582e63d27c56960011aff09e",
      "created": 1678004183,
      "updated": 1678004193
    },
    {
      "id": "64044fd7aff09e00001130ab",
      "text": "　　\t確かに話が連続してない格言集を連続で読ませて生成した時には雑な短い要約の羅列になってイマイチだった",
      "userId": "582e63d27c56960011aff09e",
      "created": 1678004183,
      "updated": 1678004193
    },
    {
      "id": "64044fd7aff09e00001130ac",
      "text": "　　\t　[/nishio/AIバルタサル・グラシアン実験#63fecb29aff09e0000a01299]",
      "userId": "582e63d27c56960011aff09e",
      "created": 1678004183,
      "updated": 1678004193
    },
    {
      "id": "64044fd7aff09e00001130ad",
      "text": "　　\t要約をするのではなく論点を一つに絞って語れ、というプロンプトに明示するといいのかな〜",
      "userId": "582e63d27c56960011aff09e",
      "created": 1678004183,
      "updated": 1678004193
    },
    {
      "id": "64044fd7aff09e00001130ae",
      "text": "",
      "userId": "582e63d27c56960011aff09e",
      "created": 1678004183,
      "updated": 1678004183
    },
    {
      "id": "64044fd7aff09e00001130af",
      "text": "2023-03-05[nishio.icon]",
      "userId": "582e63d27c56960011aff09e",
      "created": 1678004183,
      "updated": 1678004252
    },
    {
      "id": "6404501caff09e0000c03371",
      "text": " ユーザの入力のトークン数を[tiktoken]で数える",
      "userId": "582e63d27c56960011aff09e",
      "created": 1678004252,
      "updated": 1678004435
    },
    {
      "id": "6404577baff09e00001130b0",
      "text": " \t`tiktoken.get_encoding(\"cl100k_base\").encode(\"Hello, world.\")`",
      "userId": "582e63d27c56960011aff09e",
      "created": 1678006139,
      "updated": 1678006141
    },
    {
      "id": "6404505faff09e0000c03374",
      "text": " 残り何トークン取得できるか調べる(X)",
      "userId": "582e63d27c56960011aff09e",
      "created": 1678004319,
      "updated": 1678004344
    },
    {
      "id": "64045032aff09e0000c03372",
      "text": " ベクトルサーチの結果を",
      "userId": "582e63d27c56960011aff09e",
      "created": 1678004274,
      "updated": 1678004349
    },
    {
      "id": "6404508caff09e0000c03376",
      "text": " 　A: トークン上限Xで返させる",
      "userId": "582e63d27c56960011aff09e",
      "created": 1678004364,
      "updated": 1678007986
    },
    {
      "id": "6404507caff09e0000c03375",
      "text": "  B: 多めに返させて自分で切る",
      "userId": "582e63d27c56960011aff09e",
      "created": 1678004349,
      "updated": 1678004385
    },
    {
      "id": "640450a3aff09e0000c03378",
      "text": "  当初BのつもりだったがAのオプションがあるならそれでもいいな",
      "userId": "582e63d27c56960011aff09e",
      "created": 1678004388,
      "updated": 1678004407
    },
    {
      "id": "64045e9faff09e0000c0338c",
      "text": "  [LlamaIndex]にAはない　[2023-03-01 LlamaIndexのコードを読む#64045d69aff09e00001130b3]",
      "userId": "582e63d27c56960011aff09e",
      "created": 1678007967,
      "updated": 1678008170
    },
    {
      "id": "64045049aff09e0000c03373",
      "text": "　うーん、じゃあLlamaIndexのアドバンテージは特にないわけなので[LangChain]ベースに切り替えて[LangChain]と[scrapchat]のソースを読むかな",
      "userId": "582e63d27c56960011aff09e",
      "created": 1678004297,
      "updated": 1678008371
    },
    {
      "id": "64045014aff09e0000c03370",
      "text": "　　[scrapchat]の元は[LangChain Chat][blu3mo.icon]",
      "userId": "5d89b1f60230ae001779e113",
      "created": 1678004245,
      "updated": 1678014647
    },
    {
      "id": "6404789279e1130000cd0cc2",
      "text": "",
      "userId": "5d89b1f60230ae001779e113",
      "created": 1678014610,
      "updated": 1678014610
    },
    {
      "id": "640609afaff09e0000e41042",
      "text": "[AIクオリアさんv3] 2023-03-06",
      "userId": "582e63d27c56960011aff09e",
      "created": 1678117295,
      "updated": 1679420708
    },
    {
      "id": "640609c8aff09e0000e41044",
      "text": " tiktokenでトークン数を数えた",
      "userId": "582e63d27c56960011aff09e",
      "created": 1678117320,
      "updated": 1678117812
    },
    {
      "id": "64060bbaaff09e0000e41045",
      "text": " プロンプトが400程度",
      "userId": "582e63d27c56960011aff09e",
      "created": 1678117819,
      "updated": 1678117826
    },
    {
      "id": "64060bc2aff09e0000e41046",
      "text": " サンプルが1200程度",
      "userId": "582e63d27c56960011aff09e",
      "created": 1678117826,
      "updated": 1678117844
    },
    {
      "id": "64060bd4aff09e0000e41047",
      "text": " たくさん読ませたい時にサンプルを削るのが面倒で少ないけど、もっと入れられる",
      "userId": "582e63d27c56960011aff09e",
      "created": 1678117845,
      "updated": 1678117904
    },
    {
      "id": "64060c10aff09e0000e41048",
      "text": " ベクトルサーチの前にまずはそこを作る",
      "userId": "582e63d27c56960011aff09e",
      "created": 1678117905,
      "updated": 1678117918
    },
    {
      "id": "64060d06aff09e0000911d35",
      "text": " day74を丸ごと追加したけど2599",
      "userId": "582e63d27c56960011aff09e",
      "created": 1678118150,
      "updated": 1678118492
    },
    {
      "id": "64060e5eaff09e0000e41049",
      "text": " 80件くらいのリストを作ったら5000超えたのでひとまずこれで良い",
      "userId": "582e63d27c56960011aff09e",
      "created": 1678118495,
      "updated": 1678118519
    },
    {
      "id": "64060ea7aff09e0000e4104a",
      "text": " 　多分全体では10倍くらいある",
      "userId": "582e63d27c56960011aff09e",
      "created": 1678118568,
      "updated": 1678118576
    },
    {
      "id": "640610afaff09e0000e4104c",
      "text": " 頭から順に入るだけ入れる",
      "userId": "582e63d27c56960011aff09e",
      "created": 1678119087,
      "updated": 1678119098
    },
    {
      "id": "6407315faff09e0000cd37a9",
      "text": " \tcode:python",
      "userId": "582e63d27c56960011aff09e",
      "created": 1678192992,
      "updated": 1678192996
    },
    {
      "id": "64073163aff09e0000cd37aa",
      "text": " \t to_use = []",
      "userId": "582e63d27c56960011aff09e",
      "created": 1678192996,
      "updated": 1678192996
    },
    {
      "id": "64073163aff09e0000cd37ab",
      "text": "   for s in samples:",
      "userId": "582e63d27c56960011aff09e",
      "created": 1678192996,
      "updated": 1678192996
    },
    {
      "id": "64073163aff09e0000cd37ac",
      "text": "       size = get_size(s)",
      "userId": "582e63d27c56960011aff09e",
      "created": 1678192996,
      "updated": 1678192996
    },
    {
      "id": "64073163aff09e0000cd37ad",
      "text": "       if rest < size:",
      "userId": "582e63d27c56960011aff09e",
      "created": 1678192996,
      "updated": 1678192996
    },
    {
      "id": "64073163aff09e0000cd37ae",
      "text": "           break",
      "userId": "582e63d27c56960011aff09e",
      "created": 1678192996,
      "updated": 1678192996
    },
    {
      "id": "64073163aff09e0000cd37af",
      "text": "       to_use.append(s)",
      "userId": "582e63d27c56960011aff09e",
      "created": 1678192996,
      "updated": 1678192996
    },
    {
      "id": "64073163aff09e0000cd37b0",
      "text": "       rest -= size",
      "userId": "582e63d27c56960011aff09e",
      "created": 1678192996,
      "updated": 1678192996
    },
    {
      "id": "640610bdaff09e0000e4104d",
      "text": " できた",
      "userId": "582e63d27c56960011aff09e",
      "created": 1678119102,
      "updated": 1678119103
    },
    {
      "id": "64060eb0aff09e0000e4104b",
      "text": "  code:json",
      "userId": "582e63d27c56960011aff09e",
      "created": 1678118576,
      "updated": 1678119106
    },
    {
      "id": "64061091aff09e0000911d37",
      "text": "   \"usage\": {",
      "userId": "582e63d27c56960011aff09e",
      "created": 1678119057,
      "updated": 1678119106
    },
    {
      "id": "64061091aff09e0000911d38",
      "text": "       \"completion_tokens\": 72,",
      "userId": "582e63d27c56960011aff09e",
      "created": 1678119057,
      "updated": 1678119106
    },
    {
      "id": "64061091aff09e0000911d39",
      "text": "       \"prompt_tokens\": 3828,",
      "userId": "582e63d27c56960011aff09e",
      "created": 1678119057,
      "updated": 1678119106
    },
    {
      "id": "64061091aff09e0000911d3a",
      "text": "       \"total_tokens\": 3900",
      "userId": "582e63d27c56960011aff09e",
      "created": 1678119057,
      "updated": 1678119106
    },
    {
      "id": "64061091aff09e0000911d3b",
      "text": "   }",
      "userId": "582e63d27c56960011aff09e",
      "created": 1678119057,
      "updated": 1678119106
    },
    {
      "id": "64060d16aff09e0000911d36",
      "text": "　あとはこのリストが類似度順ソートになればいい",
      "userId": "582e63d27c56960011aff09e",
      "created": 1678118167,
      "updated": 1678119120
    },
    {
      "id": "640610c4aff09e0000e4104e",
      "text": "　この時点で人がプロンプトを書いていたv2までとは違うものになったと思うのでv3にした",
      "userId": "582e63d27c56960011aff09e",
      "created": 1678119109,
      "updated": 1678119263
    },
    {
      "id": "64061123aff09e0000e4104f",
      "text": "",
      "userId": "582e63d27c56960011aff09e",
      "created": 1678119203,
      "updated": 1678119203
    },
    {
      "id": "6406e580aff09e00005aeb72",
      "text": "2023-03-07[nishio.icon]",
      "userId": "582e63d27c56960011aff09e",
      "created": 1678173569,
      "updated": 1678174739
    },
    {
      "id": "6406e581aff09e00005aeb73",
      "text": "\tLangChain読む",
      "userId": "582e63d27c56960011aff09e",
      "created": 1678173570,
      "updated": 1678173577
    },
    {
      "id": "6406e588aff09e00005aeb75",
      "text": "\t[LengthBasedExampleSelector]",
      "userId": "582e63d27c56960011aff09e",
      "created": 1678173577,
      "updated": 1678173578
    },
    {
      "id": "6406e582aff09e00005aeb74",
      "text": "\t\thttps://langchain.readthedocs.io/en/latest/modules/prompts/getting_started.html#select-examples-for-a-prompt-template",
      "userId": "582e63d27c56960011aff09e",
      "created": 1678173570,
      "updated": 1678173599
    },
    {
      "id": "6406e59faff09e00005aeb76",
      "text": "　　昨日僕が作ったやつと似た目的のもの",
      "userId": "582e63d27c56960011aff09e",
      "created": 1678173599,
      "updated": 1678174388
    },
    {
      "id": "6406e8b3aff09e000080ed9d",
      "text": "\tVectorStoreとして何を選べばいいのかさっぱりわからん",
      "userId": "582e63d27c56960011aff09e",
      "created": 1678174388,
      "updated": 1678174728
    },
    {
      "id": "6406ea08aff09e00005aeb77",
      "text": "\t\t[FAISS]でいいのかな",
      "userId": "582e63d27c56960011aff09e",
      "created": 1678174729,
      "updated": 1678174735
    },
    {
      "id": "6406e8bbaff09e000080ed9e",
      "text": "\t\t[\" langchainが[faiss]（ベクトル検索ライブラリ）を呼ぶ時にエラーが出ているみたい][2023/2/21 Scrapboxの内容を元にしたチャットbotを実装する#640607ab79e11300006bc4d4]",
      "userId": "582e63d27c56960011aff09e",
      "created": 1678174396,
      "updated": 1678174837
    },
    {
      "id": "6406e8a3aff09e000080ed9c",
      "text": "　　　あー、未解決問題の原因になっちゃうのか",
      "userId": "582e63d27c56960011aff09e",
      "created": 1678174372,
      "updated": 1678174875
    },
    {
      "id": "6406ea88aff09e000080ed9f",
      "text": "  [LangChain Chat]の実装にこれが使われているので、faissで良さそうな気がします[blu3mo.icon]",
      "userId": "5d89b1f60230ae001779e113",
      "created": 1678174856,
      "updated": 1678187602
    },
    {
      "id": "64071c5279e11300009b2adf",
      "text": "  　（他の選択肢を自分は検討していないが）\t",
      "userId": "5d89b1f60230ae001779e113",
      "created": 1678187602,
      "updated": 1678187641
    },
    {
      "id": "64071c3b79e11300009b2ade",
      "text": "   このエラーに遭遇した人を他に見つけていないので、レアケースだと思って良いかと思います",
      "userId": "5d89b1f60230ae001779e113",
      "created": 1678187579,
      "updated": 1678203279
    },
    {
      "id": "64071c3579e11300009b2add",
      "text": "",
      "userId": "5d89b1f60230ae001779e113",
      "created": 1678187573,
      "updated": 1678187573
    },
    {
      "id": "64072e7aaff09e0000856fe3",
      "text": "[AIクオリアさんv4][nishio.icon]  2023-03-07",
      "userId": "582e63d27c56960011aff09e",
      "created": 1678192250,
      "updated": 1679420715
    },
    {
      "id": "64072e81aff09e0000856fe5",
      "text": " 結論:分厚い抽象化レイヤーを捨てて素朴に実装する方がいい",
      "userId": "582e63d27c56960011aff09e",
      "created": 1678192258,
      "updated": 1678192313
    },
    {
      "id": "64072e7caff09e0000856fe4",
      "text": "\t`79/79 [00:00<00:00, 10089.22it/s]`",
      "userId": "582e63d27c56960011aff09e",
      "created": 1678192252,
      "updated": 1678192685
    },
    {
      "id": "6407302caff09e0000cd3796",
      "text": "　素朴な実装で80件くらいだと0.1msec",
      "userId": "582e63d27c56960011aff09e",
      "created": 1678192684,
      "updated": 1678192800
    },
    {
      "id": "640730a8aff09e0000856fe7",
      "text": "　 ソートがO(NlogN)だからまあ1000倍の8万件でやっと1秒かなぐらいの見積もり",
      "userId": "582e63d27c56960011aff09e",
      "created": 1678192809,
      "updated": 1678192895
    },
    {
      "id": "6407db43aff09e0000970ad2",
      "text": "　 　クオリアさんは8万件もない",
      "userId": "582e63d27c56960011aff09e",
      "created": 1678236484,
      "updated": 1678236496
    },
    {
      "id": "6407db50aff09e0000970ad3",
      "text": "　 　8万件ってどれくらいかな、長文を刻んで食わせるケースだと…",
      "userId": "582e63d27c56960011aff09e",
      "created": 1678236497,
      "updated": 1678236580
    },
    {
      "id": "6407dba8aff09e0000970ad4",
      "text": "　 　 300KBのファイルが7万トークンだったのでこれを300件とすると、80MBくらい",
      "userId": "582e63d27c56960011aff09e",
      "created": 1678236585,
      "updated": 1678236683
    },
    {
      "id": "6407dc0daff09e0000970ad5",
      "text": "　 　 書籍の裁断スキャンテキストが834冊分で178MB",
      "userId": "582e63d27c56960011aff09e",
      "created": 1678236686,
      "updated": 1678236708
    },
    {
      "id": "64073100aff09e0000856fe8",
      "text": "　code:python",
      "userId": "582e63d27c56960011aff09e",
      "created": 1678192896,
      "updated": 1678192952
    },
    {
      "id": "64073138aff09e0000cd3797",
      "text": "　 class VectorStore:",
      "userId": "582e63d27c56960011aff09e",
      "created": 1678192952,
      "updated": 1678192952
    },
    {
      "id": "64073138aff09e0000cd3798",
      "text": "      def __init__(self):",
      "userId": "582e63d27c56960011aff09e",
      "created": 1678192952,
      "updated": 1678192952
    },
    {
      "id": "64073138aff09e0000cd3799",
      "text": "          self.cache = pickle.load(open(\"qualia-vector.pickle\", \"rb\"))",
      "userId": "582e63d27c56960011aff09e",
      "created": 1678192952,
      "updated": 1678192952
    },
    {
      "id": "64073138aff09e0000cd379a",
      "text": "  ",
      "userId": "582e63d27c56960011aff09e",
      "created": 1678192952,
      "updated": 1678192952
    },
    {
      "id": "64073138aff09e0000cd379b",
      "text": "      def get(self, body):",
      "userId": "582e63d27c56960011aff09e",
      "created": 1678192952,
      "updated": 1678192952
    },
    {
      "id": "64073138aff09e0000cd379c",
      "text": "          if body not in self.cache:",
      "userId": "582e63d27c56960011aff09e",
      "created": 1678192952,
      "updated": 1678192952
    },
    {
      "id": "64073138aff09e0000cd379d",
      "text": "              self.cache[body] = embed(body)",
      "userId": "582e63d27c56960011aff09e",
      "created": 1678192952,
      "updated": 1678192952
    },
    {
      "id": "64073138aff09e0000cd379e",
      "text": "              pickle.dump(open(\"qualia-vector.pickle\", \"wb\"), self.cache)",
      "userId": "582e63d27c56960011aff09e",
      "created": 1678192952,
      "updated": 1678192952
    },
    {
      "id": "64073138aff09e0000cd379f",
      "text": "          return self.cache[body]",
      "userId": "582e63d27c56960011aff09e",
      "created": 1678192952,
      "updated": 1678192952
    },
    {
      "id": "64073138aff09e0000cd37a0",
      "text": "  ",
      "userId": "582e63d27c56960011aff09e",
      "created": 1678192952,
      "updated": 1678192952
    },
    {
      "id": "64073138aff09e0000cd37a1",
      "text": "      def get_sorted(self, query):",
      "userId": "582e63d27c56960011aff09e",
      "created": 1678192952,
      "updated": 1678192952
    },
    {
      "id": "64073138aff09e0000cd37a2",
      "text": "          q = np.array(embed(query))",
      "userId": "582e63d27c56960011aff09e",
      "created": 1678192952,
      "updated": 1678192952
    },
    {
      "id": "64073138aff09e0000cd37a3",
      "text": "          buf = []",
      "userId": "582e63d27c56960011aff09e",
      "created": 1678192952,
      "updated": 1678192952
    },
    {
      "id": "64073138aff09e0000cd37a4",
      "text": "          for body, v in tqdm(self.cache.items()):",
      "userId": "582e63d27c56960011aff09e",
      "created": 1678192952,
      "updated": 1678192952
    },
    {
      "id": "64073138aff09e0000cd37a5",
      "text": "              buf.append((q.dot(v), body))",
      "userId": "582e63d27c56960011aff09e",
      "created": 1678192952,
      "updated": 1678192952
    },
    {
      "id": "64073138aff09e0000cd37a6",
      "text": "          buf.sort(reverse=True)",
      "userId": "582e63d27c56960011aff09e",
      "created": 1678192952,
      "updated": 1678192952
    },
    {
      "id": "64073138aff09e0000cd37a7",
      "text": "          return buf",
      "userId": "582e63d27c56960011aff09e",
      "created": 1678192952,
      "updated": 1678192952
    },
    {
      "id": "64073138aff09e0000cd37a8",
      "text": "　なんだかんだの末に、結局この程度のコードを書けば目的は達成できた",
      "userId": "582e63d27c56960011aff09e",
      "created": 1678192952,
      "updated": 1678193048
    },
    {
      "id": "64073056aff09e0000856fe6",
      "text": "　あとは、今は適当に80件しか入れてないけど、残りのクオリアさんの発言も全部入れようと思う",
      "userId": "582e63d27c56960011aff09e",
      "created": 1678192727,
      "updated": 1678193139
    },
    {
      "id": "640731d6aff09e0000856fea",
      "text": "",
      "userId": "582e63d27c56960011aff09e",
      "created": 1678193110,
      "updated": 1678193110
    }
  ]
}