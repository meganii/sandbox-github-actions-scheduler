{
  "id": "672cbc654a03d6434f9b6599",
  "title": "並列版(ネットワークにつながっていないページを洗い出したい)",
  "created": 1730985062,
  "updated": 1731046851,
  "lines": [
    {
      "id": "672cbc654a03d6434f9b6599",
      "text": "並列版(ネットワークにつながっていないページを洗い出したい)",
      "userId": "661b6e882a96e9002371b3c2",
      "created": 1730985062,
      "updated": 1731038883
    },
    {
      "id": "672cbc6671b3c20000151dc3",
      "text": "code:scrapCrawler.ts",
      "userId": "661b6e882a96e9002371b3c2",
      "created": 1730985062,
      "updated": 1730985072
    },
    {
      "id": "672cbc7071b3c20000151dc5",
      "text": " import * as pagelist from \"../全ページリスト(ネットワークにつながっていないページを洗い出したい)/allPages.ts\"",
      "userId": "661b6e882a96e9002371b3c2",
      "created": 1730985072,
      "updated": 1731041919
    },
    {
      "id": "672d9a4971b3c2000046100e",
      "text": " import { Logger, ILogObj } from \"npm:tslog\";",
      "userId": "661b6e882a96e9002371b3c2",
      "created": 1731041866,
      "updated": 1731046851
    },
    {
      "id": "672dad8f71b3c20000a7fb34",
      "text": " ",
      "userId": "661b6e882a96e9002371b3c2",
      "created": 1731046851,
      "updated": 1731046851
    },
    {
      "id": "672dad8f71b3c20000a7fb35",
      "text": " const logger: Logger<ILogObj> = new Logger();",
      "userId": "661b6e882a96e9002371b3c2",
      "created": 1731046851,
      "updated": 1731046851
    },
    {
      "id": "672dad8f71b3c20000a7fb36",
      "text": " logger.settings.hideLogPositionForProduction = true;",
      "userId": "661b6e882a96e9002371b3c2",
      "created": 1731046851,
      "updated": 1731046851
    },
    {
      "id": "672dad8f71b3c20000a7fb37",
      "text": " const projectName: string = Deno.args[0];",
      "userId": "661b6e882a96e9002371b3c2",
      "created": 1731046851,
      "updated": 1731046851
    },
    {
      "id": "672dad8f71b3c20000a7fb38",
      "text": " let queue: string[] = [Deno.args[1]];",
      "userId": "661b6e882a96e9002371b3c2",
      "created": 1731046851,
      "updated": 1731046851
    },
    {
      "id": "672dad8f71b3c20000a7fb39",
      "text": " const marked: string[] = [];",
      "userId": "661b6e882a96e9002371b3c2",
      "created": 1731046851,
      "updated": 1731046851
    },
    {
      "id": "672dad8f71b3c20000a7fb3a",
      "text": " interface ScrapboxPage {",
      "userId": "661b6e882a96e9002371b3c2",
      "created": 1731046851,
      "updated": 1731046851
    },
    {
      "id": "672dad8f71b3c20000a7fb3b",
      "text": "   title: string;",
      "userId": "661b6e882a96e9002371b3c2",
      "created": 1731046851,
      "updated": 1731046851
    },
    {
      "id": "672dad8f71b3c20000a7fb3c",
      "text": "   links: string[];",
      "userId": "661b6e882a96e9002371b3c2",
      "created": 1731046851,
      "updated": 1731046851
    },
    {
      "id": "672dad8f71b3c20000a7fb3d",
      "text": "   relatedPages: { links1hop: Array<{ title: string }> };",
      "userId": "661b6e882a96e9002371b3c2",
      "created": 1731046851,
      "updated": 1731046851
    },
    {
      "id": "672dad8f71b3c20000a7fb3e",
      "text": " }",
      "userId": "661b6e882a96e9002371b3c2",
      "created": 1731046851,
      "updated": 1731046851
    },
    {
      "id": "672dad8f71b3c20000a7fb3f",
      "text": " ",
      "userId": "661b6e882a96e9002371b3c2",
      "created": 1731046851,
      "updated": 1731046851
    },
    {
      "id": "672dad8f71b3c20000a7fb40",
      "text": " const getPage = async (pageName: string) => {",
      "userId": "661b6e882a96e9002371b3c2",
      "created": 1731046851,
      "updated": 1731046851
    },
    {
      "id": "672dad8f71b3c20000a7fb41",
      "text": "   logger.info(\"fetch started\",pageName)",
      "userId": "661b6e882a96e9002371b3c2",
      "created": 1731046851,
      "updated": 1731046851
    },
    {
      "id": "672dad8f71b3c20000a7fb42",
      "text": "   try {",
      "userId": "661b6e882a96e9002371b3c2",
      "created": 1731046851,
      "updated": 1731046851
    },
    {
      "id": "672dad8f71b3c20000a7fb43",
      "text": "     const pageRes = await fetch(",
      "userId": "661b6e882a96e9002371b3c2",
      "created": 1731046851,
      "updated": 1731046851
    },
    {
      "id": "672dad8f71b3c20000a7fb44",
      "text": "       \"https://scrapbox.io/api/pages/\" +",
      "userId": "661b6e882a96e9002371b3c2",
      "created": 1731046851,
      "updated": 1731046851
    },
    {
      "id": "672dad8f71b3c20000a7fb45",
      "text": "       projectName +",
      "userId": "661b6e882a96e9002371b3c2",
      "created": 1731046851,
      "updated": 1731046851
    },
    {
      "id": "672dad8f71b3c20000a7fb46",
      "text": "       \"/\" +",
      "userId": "661b6e882a96e9002371b3c2",
      "created": 1731046851,
      "updated": 1731046851
    },
    {
      "id": "672dad8f71b3c20000a7fb47",
      "text": "       encodeURIComponent(pageName)",
      "userId": "661b6e882a96e9002371b3c2",
      "created": 1731046851,
      "updated": 1731046851
    },
    {
      "id": "672dad8f71b3c20000a7fb48",
      "text": "     );",
      "userId": "661b6e882a96e9002371b3c2",
      "created": 1731046851,
      "updated": 1731046851
    },
    {
      "id": "672dad8f71b3c20000a7fb49",
      "text": "     if (pageRes.ok) {",
      "userId": "661b6e882a96e9002371b3c2",
      "created": 1731046851,
      "updated": 1731046851
    },
    {
      "id": "672dad8f71b3c20000a7fb4a",
      "text": "       const pageJson: Readonly<ScrapboxPage> = await pageRes.json();",
      "userId": "661b6e882a96e9002371b3c2",
      "created": 1731046851,
      "updated": 1731046851
    },
    {
      "id": "672dad8f71b3c20000a7fb4b",
      "text": "       logger.info(\"fetch end\", pageName);",
      "userId": "661b6e882a96e9002371b3c2",
      "created": 1731046851,
      "updated": 1731046851
    },
    {
      "id": "672dad8f71b3c20000a7fb4c",
      "text": "       marked.push(pageJson.title);",
      "userId": "661b6e882a96e9002371b3c2",
      "created": 1731046851,
      "updated": 1731046851
    },
    {
      "id": "672dad8f71b3c20000a7fb4d",
      "text": "       for (const element of pageJson.relatedPages.links1hop) {",
      "userId": "661b6e882a96e9002371b3c2",
      "created": 1731046851,
      "updated": 1731046851
    },
    {
      "id": "672dad8f71b3c20000a7fb4e",
      "text": "         if (!marked.includes(element.title)) {",
      "userId": "661b6e882a96e9002371b3c2",
      "created": 1731046851,
      "updated": 1731046851
    },
    {
      "id": "672dad8f71b3c20000a7fb4f",
      "text": "           queue.push(element.title);",
      "userId": "661b6e882a96e9002371b3c2",
      "created": 1731046851,
      "updated": 1731046851
    },
    {
      "id": "672dad8f71b3c20000a7fb50",
      "text": "         }",
      "userId": "661b6e882a96e9002371b3c2",
      "created": 1731046851,
      "updated": 1731046851
    },
    {
      "id": "672dad8f71b3c20000a7fb51",
      "text": "       }",
      "userId": "661b6e882a96e9002371b3c2",
      "created": 1731046851,
      "updated": 1731046851
    },
    {
      "id": "672dad8f71b3c20000a7fb52",
      "text": "     } else {",
      "userId": "661b6e882a96e9002371b3c2",
      "created": 1731046851,
      "updated": 1731046851
    },
    {
      "id": "672dad8f71b3c20000a7fb53",
      "text": "       logger.error(pageRes.status,await pageRes.text);",
      "userId": "661b6e882a96e9002371b3c2",
      "created": 1731046851,
      "updated": 1731046851
    },
    {
      "id": "672dad8f71b3c20000a7fb54",
      "text": "       ",
      "userId": "661b6e882a96e9002371b3c2",
      "created": 1731046851,
      "updated": 1731046851
    },
    {
      "id": "672dad8f71b3c20000a7fb55",
      "text": "     }",
      "userId": "661b6e882a96e9002371b3c2",
      "created": 1731046851,
      "updated": 1731046851
    },
    {
      "id": "672dad8f71b3c20000a7fb56",
      "text": "   } catch(e) {",
      "userId": "661b6e882a96e9002371b3c2",
      "created": 1731046851,
      "updated": 1731046851
    },
    {
      "id": "672dad8f71b3c20000a7fb57",
      "text": "     logger.error(e);",
      "userId": "661b6e882a96e9002371b3c2",
      "created": 1731046851,
      "updated": 1731046851
    },
    {
      "id": "672dad8f71b3c20000a7fb58",
      "text": "   }",
      "userId": "661b6e882a96e9002371b3c2",
      "created": 1731046851,
      "updated": 1731046851
    },
    {
      "id": "672dad8f71b3c20000a7fb59",
      "text": " };",
      "userId": "661b6e882a96e9002371b3c2",
      "created": 1731046851,
      "updated": 1731046851
    },
    {
      "id": "672dad8f71b3c20000a7fb5a",
      "text": " ",
      "userId": "661b6e882a96e9002371b3c2",
      "created": 1731046851,
      "updated": 1731046851
    },
    {
      "id": "672dad8f71b3c20000a7fb5b",
      "text": " while (queue.length > 0) {",
      "userId": "661b6e882a96e9002371b3c2",
      "created": 1731046851,
      "updated": 1731046851
    },
    {
      "id": "672dad8f71b3c20000a7fb5c",
      "text": "   const promiseList: Promise<void>[] = [];",
      "userId": "661b6e882a96e9002371b3c2",
      "created": 1731046851,
      "updated": 1731046851
    },
    {
      "id": "672dad8f71b3c20000a7fb5d",
      "text": "   for (const element of queue.splice(0, 64)) {",
      "userId": "661b6e882a96e9002371b3c2",
      "created": 1731046851,
      "updated": 1731046851
    },
    {
      "id": "672dad8f71b3c20000a7fb5e",
      "text": "     promiseList.push(getPage(element));",
      "userId": "661b6e882a96e9002371b3c2",
      "created": 1731046851,
      "updated": 1731046851
    },
    {
      "id": "672dad8f71b3c20000a7fb5f",
      "text": "   }",
      "userId": "661b6e882a96e9002371b3c2",
      "created": 1731046851,
      "updated": 1731046851
    },
    {
      "id": "672dad8f71b3c20000a7fb60",
      "text": "   await Promise.all(promiseList);",
      "userId": "661b6e882a96e9002371b3c2",
      "created": 1731046851,
      "updated": 1731046851
    },
    {
      "id": "672dad8f71b3c20000a7fb61",
      "text": "   queue = queue.filter((element, index) => {",
      "userId": "661b6e882a96e9002371b3c2",
      "created": 1731046851,
      "updated": 1731046851
    },
    {
      "id": "672dad8f71b3c20000a7fb62",
      "text": "     return queue.indexOf(element) == index && !marked.includes(element);",
      "userId": "661b6e882a96e9002371b3c2",
      "created": 1731046851,
      "updated": 1731046851
    },
    {
      "id": "672dad8f71b3c20000a7fb63",
      "text": "   });",
      "userId": "661b6e882a96e9002371b3c2",
      "created": 1731046851,
      "updated": 1731046851
    },
    {
      "id": "672dad8f71b3c20000a7fb64",
      "text": " }",
      "userId": "661b6e882a96e9002371b3c2",
      "created": 1731046851,
      "updated": 1731046851
    },
    {
      "id": "672dad8f71b3c20000a7fb65",
      "text": " ",
      "userId": "661b6e882a96e9002371b3c2",
      "created": 1731046851,
      "updated": 1731046851
    },
    {
      "id": "672dad8f71b3c20000a7fb66",
      "text": " const allpagelist = await pagelist.allpagelist(projectName);",
      "userId": "661b6e882a96e9002371b3c2",
      "created": 1731046851,
      "updated": 1731046851
    },
    {
      "id": "672dad8f71b3c20000a7fb67",
      "text": " ",
      "userId": "661b6e882a96e9002371b3c2",
      "created": 1731046851,
      "updated": 1731046851
    },
    {
      "id": "672dad8f71b3c20000a7fb68",
      "text": " const garbagelist = allpagelist.filter((value) => {",
      "userId": "661b6e882a96e9002371b3c2",
      "created": 1731046851,
      "updated": 1731046851
    },
    {
      "id": "672dad8f71b3c20000a7fb69",
      "text": "   !marked.includes(value);",
      "userId": "661b6e882a96e9002371b3c2",
      "created": 1731046851,
      "updated": 1731046851
    },
    {
      "id": "672dad8f71b3c20000a7fb6a",
      "text": " });",
      "userId": "661b6e882a96e9002371b3c2",
      "created": 1731046851,
      "updated": 1731046851
    },
    {
      "id": "672dad8f71b3c20000a7fb6b",
      "text": " ",
      "userId": "661b6e882a96e9002371b3c2",
      "created": 1731046851,
      "updated": 1731046851
    },
    {
      "id": "672dad8f71b3c20000a7fb6c",
      "text": " await Deno.writeTextFile(",
      "userId": "661b6e882a96e9002371b3c2",
      "created": 1731046851,
      "updated": 1731046851
    },
    {
      "id": "672dad8f71b3c20000a7fb6d",
      "text": "   \"result.json\",",
      "userId": "661b6e882a96e9002371b3c2",
      "created": 1731046851,
      "updated": 1731046851
    },
    {
      "id": "672dad8f71b3c20000a7fb6e",
      "text": "   JSON.stringify({ marked: marked, garbagelist: garbagelist })",
      "userId": "661b6e882a96e9002371b3c2",
      "created": 1731046851,
      "updated": 1731046851
    },
    {
      "id": "672dad8f71b3c20000a7fb6f",
      "text": " );",
      "userId": "661b6e882a96e9002371b3c2",
      "created": 1731046851,
      "updated": 1731046851
    },
    {
      "id": "672dad8f71b3c20000a7fb70",
      "text": " ",
      "userId": "661b6e882a96e9002371b3c2",
      "created": 1731046851,
      "updated": 1731046851
    }
  ]
}