{
  "id": "61061157d5b3e600223d1d5d",
  "title": "リアルタイム版ScrapCalc",
  "created": 1627787609,
  "updated": 1627909283,
  "lines": [
    {
      "id": "61061157d5b3e600223d1d5d",
      "text": "リアルタイム版ScrapCalc",
      "userId": "5ef2bdebb60650001e1280f0",
      "created": 1627787609,
      "updated": 1627787609
    },
    {
      "id": "610611571280f0000028e4a0",
      "text": "from [Scrapboxをスプレッドシートのように使う]",
      "userId": "5ef2bdebb60650001e1280f0",
      "created": 1627787609,
      "updated": 1627787609
    },
    {
      "id": "610611571280f0000028e4a2",
      "text": "[UserScript Event]版[ScrapCalc]",
      "userId": "5ef2bdebb60650001e1280f0",
      "created": 1627787609,
      "updated": 1627787609
    },
    {
      "id": "610611571280f0000028e4a3",
      "text": " ページを書き換えるたびに再計算が走る",
      "userId": "5ef2bdebb60650001e1280f0",
      "created": 1627787609,
      "updated": 1627787609
    },
    {
      "id": "6106119f1280f00000ee505d",
      "text": "　計算結果は右端に表示するようにした",
      "userId": "5ef2bdebb60650001e1280f0",
      "created": 1627787679,
      "updated": 1627787694
    },
    {
      "id": "610611b61280f00000ee5065",
      "text": "　 [/shokai/helpfeel記法 カッコ閉じ忘れチェッカー（event版）]を真似した",
      "userId": "5ef2bdebb60650001e1280f0",
      "created": 1627787703,
      "updated": 1627787729
    },
    {
      "id": "610615361280f000006e6e1d",
      "text": "　[top-level await]を有効にした",
      "userId": "5ef2bdebb60650001e1280f0",
      "created": 1627788600,
      "updated": 1627788611
    },
    {
      "id": "610615431280f000006e6e1e",
      "text": "　 まさかの`fetch`が可能",
      "userId": "5ef2bdebb60650001e1280f0",
      "created": 1627788612,
      "updated": 1627788831
    },
    {
      "id": "610611b01280f00000ee5060",
      "text": " [https://gyazo.com/6657c7620af0f16313271935335315f1]",
      "userId": "5ef2bdebb60650001e1280f0",
      "created": 1627787696,
      "updated": 1627787836
    },
    {
      "id": "6106123a1280f00000ee5067",
      "text": "",
      "userId": "5ef2bdebb60650001e1280f0",
      "created": 1627787835,
      "updated": 1627787835
    },
    {
      "id": "610789541280f00000da91f0",
      "text": "2021-08-02 14:57:43 表示結果を少しだけ見やすくした",
      "userId": "5ef2bdebb60650001e1280f0",
      "created": 1627883861,
      "updated": 1627883875
    },
    {
      "id": "610789541280f00000da91ef",
      "text": "",
      "userId": "5ef2bdebb60650001e1280f0",
      "created": 1627883860,
      "updated": 1627883860
    },
    {
      "id": "610615f31280f000006e6e24",
      "text": "実装したいこと",
      "userId": "5ef2bdebb60650001e1280f0",
      "created": 1627788788,
      "updated": 1627788790
    },
    {
      "id": "610615f61280f000006e6e25",
      "text": " 実行時エラーの表示",
      "userId": "5ef2bdebb60650001e1280f0",
      "created": 1627788790,
      "updated": 1627788798
    },
    {
      "id": "610616711280f000006e6e26",
      "text": " [throttle]で間引く",
      "userId": "5ef2bdebb60650001e1280f0",
      "created": 1627788913,
      "updated": 1627788922
    },
    {
      "id": "6106167a1280f000006e6e27",
      "text": "  `[% JSON.stringify(await (await fetch(\"/api/pages/villagepump?limit=2\")).json(), null, 2)]`のような式が書き込まれたページで編集すると、文字が変更されるたびにネットワーク通信が発生してしまう……",
      "userId": "5ef2bdebb60650001e1280f0",
      "created": 1627788922,
      "updated": 1627788984
    },
    {
      "id": "610616b91280f000006e6e28",
      "text": "   [- そもそもScrapCalcでAPI叩くなよ]",
      "userId": "5ef2bdebb60650001e1280f0",
      "created": 1627788986,
      "updated": 1627789013
    },
    {
      "id": "610615f11280f000006e6e23",
      "text": "",
      "userId": "566fa156776c9b11008ee92a",
      "created": 1627788785,
      "updated": 1627817352
    },
    {
      "id": "610611b01280f00000ee5061",
      "text": " [% a = 100]",
      "userId": "566fa156776c9b11008ee92a",
      "created": 1627787696,
      "updated": 1627817310
    },
    {
      "id": "610611b01280f00000ee5062",
      "text": " [% b = 200]",
      "userId": "5ef2bdebb60650001e1280f0",
      "created": 1627787697,
      "updated": 1627787697
    },
    {
      "id": "610611b01280f00000ee5063",
      "text": " [% a + b]",
      "userId": "5ef2bdebb60650001e1280f0",
      "created": 1627787697,
      "updated": 1627787697
    },
    {
      "id": "610615801280f000006e6e22",
      "text": " [% (()=>{const c = 100; return a+b+c})()]",
      "userId": "5ef2bdebb60650001e1280f0",
      "created": 1627788672,
      "updated": 1627788867
    },
    {
      "id": "610611b01280f00000ee5064",
      "text": " [%  Date()]",
      "userId": "5ef2bdebb60650001e1280f0",
      "created": 1627787697,
      "updated": 1627787737
    },
    {
      "id": "610611de1280f00000ee5066",
      "text": " [% JSON.stringify(scrapbox.Page.lines.length)]",
      "userId": "5ef2bdebb60650001e1280f0",
      "created": 1627787743,
      "updated": 1627787829
    },
    {
      "id": "6106119e1280f00000ee505c",
      "text": " [% JSON.stringify(await (await fetch(\"/api/pages/villagepump?limit=2\")).json(), null, 2)]",
      "userId": "5ef2bdebb60650001e1280f0",
      "created": 1627787679,
      "updated": 1627788569
    },
    {
      "id": "610611571280f0000028e4a5",
      "text": "",
      "userId": "566fa156776c9b11008ee92a",
      "created": 1627787609,
      "updated": 1627817295
    },
    {
      "id": "610611571280f0000028e4a7",
      "text": "code:script.js",
      "userId": "5ef2bdebb60650001e1280f0",
      "created": 1627787609,
      "updated": 1627787609
    },
    {
      "id": "610611571280f0000028e4a8",
      "text": " scrapbox.on('lines:changed', update);",
      "userId": "5ef2bdebb60650001e1280f0",
      "created": 1627787609,
      "updated": 1627787609
    },
    {
      "id": "610611571280f0000028e4a9",
      "text": " update(); // 初期化",
      "userId": "5ef2bdebb60650001e1280f0",
      "created": 1627787609,
      "updated": 1627788043
    },
    {
      "id": "610611571280f0000028e4aa",
      "text": " ",
      "userId": "5ef2bdebb60650001e1280f0",
      "created": 1627787609,
      "updated": 1627787609
    },
    {
      "id": "610611571280f0000028e4ab",
      "text": " function update() {",
      "userId": "5ef2bdebb60650001e1280f0",
      "created": 1627787609,
      "updated": 1627787609
    },
    {
      "id": "610611571280f0000028e4ac",
      "text": "   const code = `(async () => {${strict()}})();`;",
      "userId": "5ef2bdebb60650001e1280f0",
      "created": 1627787609,
      "updated": 1627788135
    },
    {
      "id": "610611571280f0000028e4ad",
      "text": "   //console.log(code);",
      "userId": "5ef2bdebb60650001e1280f0",
      "created": 1627787609,
      "updated": 1627788036
    },
    {
      "id": "610611571280f0000028e4ae",
      "text": "   const sneaky = Function(code);",
      "userId": "5ef2bdebb60650001e1280f0",
      "created": 1627787609,
      "updated": 1627787609
    },
    {
      "id": "610611571280f0000028e4af",
      "text": "   sneaky();",
      "userId": "5ef2bdebb60650001e1280f0",
      "created": 1627787609,
      "updated": 1627787609
    },
    {
      "id": "610611571280f0000028e4b0",
      "text": " }",
      "userId": "5ef2bdebb60650001e1280f0",
      "created": 1627787609,
      "updated": 1627787609
    },
    {
      "id": "610611571280f0000028e4b1",
      "text": " ",
      "userId": "5ef2bdebb60650001e1280f0",
      "created": 1627787609,
      "updated": 1627787609
    },
    {
      "id": "610611571280f0000028e4b2",
      "text": "",
      "userId": "5ef2bdebb60650001e1280f0",
      "created": 1627787609,
      "updated": 1627787609
    },
    {
      "id": "6107ac2b385a920000070404",
      "text": " `const code = \\`(async () => {${strict()}})();\\`;`",
      "userId": "5953adab7aa58a0011385a92",
      "created": 1627892779,
      "updated": 1627892793
    },
    {
      "id": "6107ac2b385a920000070403",
      "text": "  top level awaitできなくてだるいなーと思ってたので助かる[miyamonz.icon]",
      "userId": "5953adab7aa58a0011385a92",
      "created": 1627892779,
      "updated": 1627892818
    },
    {
      "id": "6107ac52385a920000070406",
      "text": "  盲点だった",
      "userId": "5953adab7aa58a0011385a92",
      "created": 1627892818,
      "updated": 1627892823
    },
    {
      "id": "6107ddfe1280f0000026b9d7",
      "text": "  それはよかったです[takker.icon]",
      "userId": "5ef2bdebb60650001e1280f0",
      "created": 1627905535,
      "updated": 1627905556
    },
    {
      "id": "6107de041280f0000026b9d8",
      "text": "   でもtop level awaitって何に使うんだろう？",
      "userId": "5ef2bdebb60650001e1280f0",
      "created": 1627905540,
      "updated": 1627905552
    },
    {
      "id": "6107e134385a920000dadcde",
      "text": "   [ScrapJupyter]とかでさっとawaitしたいとき[miyamonz.icon]",
      "userId": "5953adab7aa58a0011385a92",
      "created": 1627906355,
      "updated": 1627906371
    },
    {
      "id": "6107e184385a920000dadce1",
      "text": "   　thenでかくのeditorじゃないとだるい",
      "userId": "5953adab7aa58a0011385a92",
      "created": 1627906436,
      "updated": 1627906454
    },
    {
      "id": "6107e144385a920000dadce0",
      "text": "  やろうとおもったけどglobalスコープじゃなくなっちゃうからセルをまたいだ変数が使えなくなってしまう、、、ショボーン",
      "userId": "5953adab7aa58a0011385a92",
      "created": 1627906371,
      "updated": 1627906413
    },
    {
      "id": "6107ec3b1280f0000026b9d9",
      "text": "   [% window.d = 100]と毎回書くか、scriptの方で自動的に`window.`を使うかのどちらかでしょうね[takker.icon]",
      "userId": "5ef2bdebb60650001e1280f0",
      "created": 1627909180,
      "updated": 1627909283
    },
    {
      "id": "6107ec771280f0000026b9db",
      "text": "    `window.jupyterStorage`のような適当なglobal変数を生やして、そこに入れるようにするのも手",
      "userId": "5ef2bdebb60650001e1280f0",
      "created": 1627909240,
      "updated": 1627909280
    },
    {
      "id": "6107ac58385a920000070407",
      "text": "",
      "userId": "5953adab7aa58a0011385a92",
      "created": 1627892824,
      "updated": 1627892824
    },
    {
      "id": "610611571280f0000028e4b3",
      "text": "Firefoxだと`eval()`がstrict modeになっているぽかったので、[Page MenuからScrapCalcを動かす]にある回避策を用いた",
      "userId": "5ef2bdebb60650001e1280f0",
      "created": 1627787609,
      "updated": 1627787609
    },
    {
      "id": "610611571280f0000028e4b4",
      "text": "code:script.js",
      "userId": "5ef2bdebb60650001e1280f0",
      "created": 1627787609,
      "updated": 1627787609
    },
    {
      "id": "610611571280f0000028e4b5",
      "text": " function strict(){",
      "userId": "5ef2bdebb60650001e1280f0",
      "created": 1627787609,
      "updated": 1627787609
    },
    {
      "id": "610611571280f0000028e4b6",
      "text": "   // 一旦リセット",
      "userId": "5ef2bdebb60650001e1280f0",
      "created": 1627787609,
      "updated": 1627787609
    },
    {
      "id": "610611571280f0000028e4b7",
      "text": "   document.querySelectorAll('span[data-id=\"scrapExec-calculated\"]')",
      "userId": "5ef2bdebb60650001e1280f0",
      "created": 1627787609,
      "updated": 1627787609
    },
    {
      "id": "610611571280f0000028e4b8",
      "text": "     .forEach(span => span.remove());",
      "userId": "5ef2bdebb60650001e1280f0",
      "created": 1627787609,
      "updated": 1627787609
    },
    {
      "id": "610611571280f0000028e4b9",
      "text": "     ",
      "userId": "5ef2bdebb60650001e1280f0",
      "created": 1627787609,
      "updated": 1627787609
    },
    {
      "id": "610611571280f0000028e4ba",
      "text": "   const commands = [...document.querySelectorAll('.deco-\\\\%')]",
      "userId": "5ef2bdebb60650001e1280f0",
      "created": 1627787609,
      "updated": 1627787609
    },
    {
      "id": "610611571280f0000028e4bb",
      "text": "     .map((expr, index) => {",
      "userId": "5ef2bdebb60650001e1280f0",
      "created": 1627787609,
      "updated": 1627787609
    },
    {
      "id": "610611571280f0000028e4bc",
      "text": "       // 全角 ［ を半角 [ にする",
      "userId": "5ef2bdebb60650001e1280f0",
      "created": 1627787609,
      "updated": 1627787609
    },
    {
      "id": "610611571280f0000028e4bd",
      "text": "      let text = expr.innerText.replace(/［/g,'[').replace(/］/g,']');",
      "userId": "5ef2bdebb60650001e1280f0",
      "created": 1627787609,
      "updated": 1627787609
    },
    {
      "id": "610613181280f00000ee506d",
      "text": "      // 記法がむき出しになっていた場合の処理",
      "userId": "5ef2bdebb60650001e1280f0",
      "created": 1627788057,
      "updated": 1627788064
    },
    {
      "id": "610611571280f0000028e4be",
      "text": "      if (expr.closest('div.line').classList.contains('cursor-line')) {",
      "userId": "5ef2bdebb60650001e1280f0",
      "created": 1627787609,
      "updated": 1627787609
    },
    {
      "id": "610611571280f0000028e4bf",
      "text": "        text = text.slice(3, -1);",
      "userId": "5ef2bdebb60650001e1280f0",
      "created": 1627787609,
      "updated": 1627787609
    },
    {
      "id": "610611571280f0000028e4c0",
      "text": "      }",
      "userId": "5ef2bdebb60650001e1280f0",
      "created": 1627787609,
      "updated": 1627787609
    },
    {
      "id": "6106132c1280f00000ee506e",
      "text": "      // decodeできるときだけdecodeする",
      "userId": "5ef2bdebb60650001e1280f0",
      "created": 1627788076,
      "updated": 1627788084
    },
    {
      "id": "610611571280f0000028e4c1",
      "text": "      try {",
      "userId": "5ef2bdebb60650001e1280f0",
      "created": 1627787609,
      "updated": 1627787609
    },
    {
      "id": "610611571280f0000028e4c2",
      "text": "        text = decodeURI(text);",
      "userId": "5ef2bdebb60650001e1280f0",
      "created": 1627787609,
      "updated": 1627787609
    },
    {
      "id": "610611571280f0000028e4c3",
      "text": "      } catch(e) {",
      "userId": "5ef2bdebb60650001e1280f0",
      "created": 1627787609,
      "updated": 1627787609
    },
    {
      "id": "610611571280f0000028e4c4",
      "text": "        if (!(e instanceof URIError)) throw e;",
      "userId": "5ef2bdebb60650001e1280f0",
      "created": 1627787609,
      "updated": 1627787609
    },
    {
      "id": "610611571280f0000028e4c5",
      "text": "      }",
      "userId": "5ef2bdebb60650001e1280f0",
      "created": 1627787609,
      "updated": 1627787609
    },
    {
      "id": "610611571280f0000028e4ca",
      "text": "      const id = expr.closest('div.line')?.id;",
      "userId": "5ef2bdebb60650001e1280f0",
      "created": 1627787609,
      "updated": 1627788539
    },
    {
      "id": "610611571280f0000028e4cb",
      "text": "      return `document.getElementById('${id}')?.insertAdjacentHTML?.(`",
      "userId": "5ef2bdebb60650001e1280f0",
      "created": 1627787609,
      "updated": 1627788539
    },
    {
      "id": "610611571280f0000028e4cc",
      "text": "        + \"'beforeend', \"",
      "userId": "5ef2bdebb60650001e1280f0",
      "created": 1627787609,
      "updated": 1627788539
    },
    {
      "id": "610611571280f0000028e4cd",
      "text": "        + `\\`<span data-id=\"scrapExec-calculated\" style=\"position:absolute;top:0;right:0;font-style:italic;font-weight:bold;word-wrap:break-word;white-space:break-spaces;max-width:30vw;\">`",
      "userId": "5ef2bdebb60650001e1280f0",
      "created": 1627787609,
      "updated": 1627883842
    },
    {
      "id": "610611571280f0000028e4ce",
      "text": "        + \"${\" + text + \"}\"",
      "userId": "5ef2bdebb60650001e1280f0",
      "created": 1627787609,
      "updated": 1627788539
    },
    {
      "id": "610611571280f0000028e4cf",
      "text": "        + \"</span>`\"",
      "userId": "5ef2bdebb60650001e1280f0",
      "created": 1627787609,
      "updated": 1627788539
    },
    {
      "id": "610611571280f0000028e4d0",
      "text": "        + \");\";",
      "userId": "5ef2bdebb60650001e1280f0",
      "created": 1627787609,
      "updated": 1627788539
    },
    {
      "id": "610611571280f0000028e4d2",
      "text": "     });",
      "userId": "5ef2bdebb60650001e1280f0",
      "created": 1627787609,
      "updated": 1627787609
    },
    {
      "id": "610611571280f0000028e4d3",
      "text": "   ",
      "userId": "5ef2bdebb60650001e1280f0",
      "created": 1627787609,
      "updated": 1627787609
    },
    {
      "id": "610611571280f0000028e4d4",
      "text": "   return commands.join(\"\\n\");",
      "userId": "5ef2bdebb60650001e1280f0",
      "created": 1627787609,
      "updated": 1627787609
    },
    {
      "id": "610611571280f0000028e4d5",
      "text": " }",
      "userId": "5ef2bdebb60650001e1280f0",
      "created": 1627787609,
      "updated": 1627787609
    },
    {
      "id": "6106839d8ee92a0000ea7a89",
      "text": "",
      "userId": "566fa156776c9b11008ee92a",
      "created": 1627816862,
      "updated": 1627816862
    },
    {
      "id": "610683af8ee92a0000ea7a8d",
      "text": "",
      "userId": "566fa156776c9b11008ee92a",
      "created": 1627816879,
      "updated": 1627816879
    }
  ]
}